# This is a configuration file for the Creatbot motherboard.

[include D600Pro2_Head.cfg]

[mcu]
canbus_uuid:000000000010
canbus_interface: can0

[printer]
kinematics: cartesian
max_velocity: 300
max_accel: 5000
max_z_velocity: 10
max_z_accel: 100
square_corner_velocity: 2.5

[bed_mesh]
speed: 300
horizontal_move_z: 3
mesh_min: 40,60
mesh_max: 600, 600
probe_count: 6,6
mesh_pps: 2,2
algorithm: bicubic
bicubic_tension: 0.2
horizontal_move_z: 10

[stepper_x]
step_pin: PD1
dir_pin: PD0
enable_pin: !PA15
rotation_distance: 75
microsteps: 100
full_steps_per_rotation: 200
position_min: 0
position_endstop: 0
position_max: 600
homing_speed: 100
homing_retract_dist: 10
# homing_positive_dir: true

[stepper_y]
step_pin: PD4
dir_pin: !PD3
enable_pin: !PD2
rotation_distance: 75
microsteps: 40
full_steps_per_rotation: 200
gear_ratio: 2.5:1
endstop_pin: PC11
position_min: 0
position_endstop: 0
position_max: 600
homing_speed: 100
homing_retract_dist: 10
# homing_positive_dir: true

[stepper_z]
step_pin: PD7
dir_pin: PD6
enable_pin: !PD5
rotation_distance: 5
gear_ratio: 2.5:1
microsteps: 16
full_steps_per_rotation: 200
endstop_pin: probe:z_virtual_endstop
position_max: 600
position_min: 0
homing_speed: 5
second_homing_speed: 1
homing_retract_dist: 2.0

[heater_bed]
heater_pin: PD12
sensor_type: Generic 3950
sensor_pin: PC0
max_power: 1.0
min_temp: -12
max_temp: 110

control: pid
pid_kp: 17.22
pid_ki: 0.9
pid_kd: 218.61

[verify_heater heater_bed]
max_error: 20
hysteresis: 5
check_gain_time: 120
heating_gain: 2

[heater_generic chamber]
heater_pin:PD15
max_power:1.0
sensor_type:Generic 3950
sensor_pin:PC3
min_temp:-238
max_temp:80
control = pid
pid_kp: 30.68
pid_ki: 0.21
pid_kd: 0

[verify_heater chamber]
max_error: 120
hysteresis: 5
check_gain_time:300
heating_gain: 1

[fan_generic Air_filter_fan]
pin: PC8
max_power: 1.0
shutdown_speed: 0.0
kick_start_time: 1.0
off_below: 0.10

[filament_switch_sensor extruder]
pause_on_runout: True
runout_gcode:

event_delay: 3.0
pause_delay: 0.5
switch_pin:PC14

[filament_switch_sensor extruder1]
pause_on_runout: True
runout_gcode:

event_delay: 3.0
pause_delay: 0.5
switch_pin:PC15

[mcu tool]
canbus_uuid: 000000000001
canbus_interface: can0

[stepper_x]
endstop_pin: tool:PC0

[adxl345]
spi_speed: 5000000
cs_pin: tool:PB12
spi_software_sclk_pin:tool:PB13
spi_software_mosi_pin:tool:PB15
spi_software_miso_pin:tool:PB14
rate: 3200

[resonance_tester]
accel_chip: adxl345
probe_points: 300, 300, 20
min_freq: 25
max_freq: 70
accel_per_hz: 100
hz_per_sec: 1

[fan]
pin:tool:PA10
kick_start_time: 0.5
off_below: 0.10
max_power: 1.0

[heater_fan Sink_fan_0]
pin:tool:PA8
max_power: 1.0
kick_start_time: 0.5
heater: extruder
off_below: 0.10
heater_temp: 100

[heater_fan Sink_fan_1]
pin:tool:PA9
max_power: 1.0
kick_start_time: 0.5
heater: extruder1
off_below: 0.10
heater_temp: 100

[extruder]
sensor_type: MAX31855
sensor_pin: tool:PD2
spi_software_sclk_pin:tool:PB3
spi_software_mosi_pin:tool:PB5
spi_software_miso_pin:tool:PB4

[verify_heater extruder]
max_error: 20
check_gain_time: 30
hysteresis: 10
heating_gain: 2

[extruder]
step_pin: tool:PB1
dir_pin: tool:PB2
enable_pin: !tool:PB0
microsteps: 16
full_steps_per_rotation: 200
rotation_distance:22.9116807962642578993
gear_ratio: 48:19
nozzle_diameter: 1.00
filament_diameter: 1.750
max_extrude_only_distance: 500.0
max_extrude_only_velocity: 60.0
max_extrude_only_accel: 1000.0
max_extrude_cross_section:5
heater_pin: tool:PC6
max_power: 1.0
min_temp: -235
max_temp: 450
min_extrude_temp: 180
pressure_advance: 0.03
pressure_advance_smooth_time:0.040
control = pid
pid_kp = 23.904
pid_ki = 1.476
pid_kd = 96.810

[tmc5160 extruder]
cs_pin:tool:PB7
spi_software_sclk_pin:tool:PB3
spi_software_mosi_pin:tool:PB5
spi_software_miso_pin:tool:PB4
run_current: 0.5
interpolate: False
sense_resistor: 0.075
stealthchop_threshold: 0

[extruder1]
sensor_type: MAX31855
sensor_pin: tool:PC12
spi_software_sclk_pin:tool:PB3
spi_software_mosi_pin:tool:PB5
spi_software_miso_pin:tool:PB4

[verify_heater extruder1]
max_error: 20
check_gain_time: 30
hysteresis: 10
heating_gain: 2

[extruder1]
step_pin: tool:PC4
dir_pin: tool:PA7
enable_pin: !tool:PC5
microsteps: 16
full_steps_per_rotation: 200
rotation_distance: 22.9116807962642578993
gear_ratio: 48:19
nozzle_diameter: 0.400
filament_diameter: 1.750
max_extrude_only_distance: 500.0
max_extrude_only_velocity: 60.0
max_extrude_only_accel: 1000.0
heater_pin: tool:PC7
max_power: 1.0
min_temp: -12
max_temp: 450
min_extrude_temp: 180
pressure_advance: 0.032
pressure_advance_smooth_time:0.040
control = pid
pid_kp = 23.904
pid_ki = 1.476
pid_kd = 96.810

[tmc5160 extruder1]
cs_pin:tool:PC11
spi_software_sclk_pin:tool:PB3
spi_software_mosi_pin:tool:PB5
spi_software_miso_pin:tool:PB4
run_current: 0.5
interpolate: False
sense_resistor: 0.075
stealthchop_threshold: 0

[probe]
pin: !tool:PC2
x_offset: 36
y_offset: 59
#z_offset: 1.699
#speed: 10.0
#samples: 3
#samples_result: median
#sample_retract_dist: 4.0
#samples_tolerance: 0.007
#samples_tolerance_retries: 3
deactivate_on_each_sample: False
activate_gcode: probe_open
deactivate_gcode: probe_close

[safe_z_home]
home_xy_position:300,300
speed:200
z_hop:5

[servo probe_servo]
pin: tool:PC8

maximum_servo_angle: 180
minimum_pulse_width: 0.000900
maximum_pulse_width: 0.002100
initial_angle: 160
# initial_pulse_width:

[servo switch_nozzle]
pin: tool:PC9
maximum_servo_angle: 270
minimum_pulse_width: 0.000512
maximum_pulse_width: 0.002528
initial_angle: 135
# initial_pulse_width:

[gcode_macro M141]
gcode:
    {% set s = params.S|default(0)|float %}
    SET_HEATER_TEMPERATURE HEATER=chamber target={s}

[gcode_macro T0]
gcode:
    SET_SERVO SERVO=switch_nozzle angle=135                             
    G4 P500
    SET_GCODE_OFFSET Z=0 MOVE=1 MOVE_SPEED=200                        
    SET_GCODE_OFFSET Y=0 MOVE=1 MOVE_SPEED=200                        
    SET_GCODE_OFFSET X=0 MOVE=1 MOVE_SPEED=200                        
    SET_SERVO SERVO=switch_nozzle angle=45                            
    ACTIVATE_EXTRUDER EXTRUDER=extruder 

[gcode_macro T1] 
gcode:
    SET_SERVO SERVO=switch_nozzle angle=135                            
    G4 P500
    SET_GCODE_OFFSET Z=0.918228  MOVE=1 MOVE_SPEED=200
    SET_GCODE_OFFSET Y=0.433750  MOVE=1 MOVE_SPEED=200
    SET_GCODE_OFFSET X=-59.227500 MOVE=1 MOVE_SPEED=200
    SET_SERVO SERVO=switch_nozzle angle=225                            
    ACTIVATE_EXTRUDER EXTRUDER=extruder1

[gcode_macro probe_open]
gcode:
    SET_SERVO SERVO=probe_servo angle=15 
    G4 P1000

[gcode_macro probe_close]
gcode:
   SET_SERVO SERVO=probe_servo angle=130

[gcode_arcs]                    
resolution: 1.0                  

[gcode_macro PRINT_START]  
gcode:
    {% set BED_TEMP = params.BED|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER|float %}
    {% set EXTRUDER_TEMP1 = params.EXTRUDER1|default(0)|float %}
    {% set CHAMBER_TEMP = params.CHAMBER|default(0)|float %}
   
    M140 S{BED_TEMP}
    M104 S{EXTRUDER_TEMP}
    M104 T1 S{EXTRUDER_TEMP1}
    M141 S{CHAMBER_TEMP}
    T0
    G28                            
    BED_MESH_CALIBRATE
    M109 S{EXTRUDER_TEMP}         
    M109 T1 S{EXTRUDER_TEMP1}
    G92 E0
    M117 Printing star...

[gcode_macro PRINT_END]          
gcode:
    M400                         
    G92 E0                       
    G1 E-10.0 F3600              
    G91                          
    G0 Z1.00 X20.0 Y20.0 F6000   
    TURN_OFF_HEATERS             
    M107                         
    G1 Z2 F3000                  
    G90                          
    G0  X590 Y590 F3600          
    BED_MESH_CLEAR               

[gcode_macro M109]
rename_existing: M109109
gcode:
    {% set s = params.S|float %}
    
    M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={s} MAXIMUM={s+1}
    {% endif %}		

[gcode_macro LOAD_FILAMENT]
variable_load_distance:  100
variable_purge_distance:  25
gcode:
    {% set speed = params.SPEED|default(200) %}
    {% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity  * 60 %}
    SAVE_GCODE_STATE NAME=load_state
    G91
    G92 E0
    G1 E{load_distance} F{max_velocity} # fast-load
    G1 E{purge_distance} F{speed} # purge
    RESTORE_GCODE_STATE NAME=load_state

[gcode_macro UNLOAD_FILAMENT]
variable_unload_distance:  100
variable_purge_distance:  25
gcode:
    {% set speed = params.SPEED|default(200) %}
    {% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity  * 60 %}
    SAVE_GCODE_STATE NAME=unload_state
    G91
    G92 E0
    G1 E{purge_distance} F{speed} # purge
    G1 E-{unload_distance} F{max_velocity} # fast-unload
    RESTORE_GCODE_STATE NAME=unload_state
