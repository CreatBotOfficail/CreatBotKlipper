# This is a configuration file for the Creatbot F430NX.

[virtual_sdcard]
path: /home/klipper/printer_data/gcodes
on_error_gcode: CANCEL_PRINT
[exclude_object]

[idle_timeout]
timeout: 1800

# F446 MotherBoard ID
[mcu]                           
canbus_uuid: 000000000010
canbus_interface: can0

[printer]                      
kinematics: cartesian           
max_velocity: 300               
max_accel: 5000                 
max_z_velocity: 8              
max_z_accel: 100               
square_corner_velocity: 4.0     

[bed_mesh]
speed: 200
horizontal_move_z: 5
mesh_min: 34.6,17.4
mesh_max: 420, 300
probe_count: 5,4
mesh_pps: 2,2
algorithm: bicubic
bicubic_tension: 0.2


[stepper_x]
step_pin: PD1                       
dir_pin: !PD0                       
enable_pin: !PA15                  
rotation_distance: 50.8            
microsteps: 64                    
full_steps_per_rotation: 200      
endstop_pin: ^PC10              
position_min: -10                   
position_endstop: 0                 
position_max: 420                   
homing_speed: 100                   
homing_retract_dist: 10              

[tmc5160 stepper_x]                
cs_pin: PE2                       
spi_software_sclk_pin: PB3
spi_software_mosi_pin: PB5
spi_software_miso_pin: PB4
run_current: 1.0
hold_current: 0.5               
interpolate: True                 
sense_resistor: 0.075              
stealthchop_threshold: 200

[dual_carriage]
axis: x
step_pin: PE11
dir_pin: !PE10
enable_pin: !PE9
rotation_distance: 50.8
microsteps: 64
full_steps_per_rotation: 200
endstop_pin: ^PE7
position_endstop: 495
position_min: 75
position_max: 500
homing_speed: 100
homing_retract_dist: 10
safe_distance: 20


[tmc5160 dual_carriage]
cs_pin: PE8                        
spi_software_sclk_pin: PB3
spi_software_mosi_pin: PB5
spi_software_miso_pin: PB4
run_current: 1.0
hold_current: 0.5                
interpolate: True                 
sense_resistor: 0.075              
stealthchop_threshold: 200      


[stepper_y]
step_pin: PD4
dir_pin: !PD3
enable_pin: !PD2
rotation_distance: 73.152
microsteps: 128                    
full_steps_per_rotation: 200      
gear_ratio: 1:1
endstop_pin: ^PC11               
position_min: -10
position_endstop: 0
position_max: 300
homing_speed: 60
homing_retract_dist: 10

[tmc5160 stepper_y]                
cs_pin: PE3
spi_software_sclk_pin: PB3
spi_software_mosi_pin: PB5
spi_software_miso_pin: PB4
run_current: 2.0
hold_current: 0.5
interpolate: True
sense_resistor: 0.075
stealthchop_threshold: 200

[stepper_z]
step_pin: PD7
dir_pin: PD6
enable_pin: !PD5
rotation_distance: 5
gear_ratio: 2.5:1
microsteps: 16
full_steps_per_rotation: 200
endstop_pin: probe:z_virtual_endstop 
position_max: 300
position_min: 0
homing_speed: 10
second_homing_speed: 1
homing_retract_dist: 2.0

[tmc5160 stepper_z]
cs_pin: PE4
spi_software_sclk_pin: PB3
spi_software_mosi_pin: PB5
spi_software_miso_pin: PB4
run_current: 1.4
hold_current: 0.5
interpolate: True
sense_resistor: 0.075
stealthchop_threshold: 10

[heater_bed]
heater_pin: PD12
sensor_type: Generic 3950
sensor_pin: PC0
max_power: 1.0
min_temp: -235
max_temp: 160
control: pid
pid_kp: 74.000
pid_ki: 1.965
pid_kd: 696.525

[verify_heater heater_bed]
max_error: 20
check_gain_time:90
hysteresis: 5
heating_gain: 2

[heater_generic chamber]
heater_pin:PD15
max_power:1.0
sensor_type:Generic 3950
sensor_pin:PC3
min_temp:-238
max_temp:80
control: pid
pid_kp: 30.68
pid_ki: 0.21
pid_kd: 0

[verify_heater chamber]
max_error: 20
hysteresis: 2

[multi_pin fan]
pins: L_tool:PA10, R_tool:PA10

[fan]
pin: multi_pin:fan
max_power: 1.0
shutdown_speed: 0.0
kick_start_time: 1.0
off_below: 0.15

[fan_generic Air_filter_fan]
pin: PC8
max_power: 1.0
shutdown_speed: 0.0
kick_start_time: 1.0

[led Interior_lighting]
white_pin: PC7
cycle_time: 0.010
initial_WHITE: 1

[neopixel Status_light]
pin: PB8
chain_count: 1
color_order: RGB
initial_RED: 0.3
initial_GREEN: 0.3
initial_BLUE: 0.3

[safe_z_home]
home_xy_position:200,150
speed:150
z_hop:5

[filament_switch_sensor extruder]
pause_on_runout: True
runout_gcode:
event_delay: 3.0
pause_delay: 0.5
switch_pin:PC14

[filament_switch_sensor extruder1]
pause_on_runout: True
runout_gcode:    
event_delay: 3.0
pause_delay: 0.5
switch_pin:PC15 

# F072 Left nozzle ID
[mcu L_tool]
canbus_uuid: 000000000001
canbus_interface: can0

[adxl345]
spi_speed: 5000000
cs_pin: L_tool:PB12
spi_software_sclk_pin:L_tool:PB13
spi_software_mosi_pin:L_tool:PB15
spi_software_miso_pin:L_tool:PB14
axes_map: -x, -z, -y
rate: 3200

[resonance_tester]
accel_chip: adxl345
probe_points: 200, 150, 20
min_freq: 25
max_freq: 70
accel_per_hz: 100
hz_per_sec: 1 

[heater_fan Sink_fan_0]
pin:L_tool:PA9
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 100
fan_speed:1.0

[extruder]
sensor_type: MAX31855
sensor_pin: L_tool:PA15
spi_software_sclk_pin:L_tool:PB3
spi_software_mosi_pin:L_tool:PB5
spi_software_miso_pin:L_tool:PB4
[verify_heater extruder]
max_error: 5
check_gain_time:30
hysteresis: 25
heating_gain: 2

[extruder]
step_pin: L_tool:PB1
dir_pin: !L_tool:PB2
enable_pin: !L_tool:PB0
microsteps: 16
full_steps_per_rotation: 200
rotation_distance:23.5619445
gear_ratio: 2.53:1
nozzle_diameter: 0.400
filament_diameter: 1.750
max_extrude_only_distance: 500.0
max_extrude_only_velocity: 60.0
max_extrude_only_accel: 1000.0
max_extrude_cross_section:5
heater_pin: L_tool:PA8
max_power: 1.0
min_temp: -235
max_temp: 465
min_extrude_temp: 150
pressure_advance: 0.032
pressure_advance_smooth_time:0.040
control = pid
pid_kp = 10.391
pid_ki = 0.376
pid_kd = 71.698

[tmc2209 extruder]
uart_pin:L_tool:PB7
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

[probe]
pin: ^!L_tool:PA1                 
x_offset: 34.6            
y_offset: 17.4          
z_offset: 0
speed: 10.0
samples: 3
samples_result: median
sample_retract_dist: 5.0
samples_tolerance: 0.007
samples_tolerance_retries: 3
deactivate_on_each_sample: False
activate_gcode:     probe_start
deactivate_gcode:   probe_end

[servo probe_servo]
pin:L_tool:PA5
maximum_servo_angle: 180
minimum_pulse_width: 0.000900
maximum_pulse_width: 0.002100
initial_angle: 160
# initial_pulse_width:


[input_shaper]
shaper_freq_x: 0
shaper_freq_y: 0
shaper_type: mzv
#shaper_type_x:
#shaper_type_y:
damping_ratio_x: 0.1
damping_ratio_y: 0.1

# F072 Right nozzle ID
[mcu R_tool]
canbus_uuid: 000000000002 
canbus_interface: can0

[heater_fan Sink_fan_1]
pin:R_tool:PA9
max_power: 1.0
kick_start_time: 0.5
heater: extruder1
heater_temp: 100
fan_speed: 1

[extruder1]
sensor_type: MAX31855
sensor_pin: R_tool:PA15
spi_software_sclk_pin:R_tool:PB3
spi_software_mosi_pin:R_tool:PB5
spi_software_miso_pin:R_tool:PB4
[verify_heater extruder1]
max_error: 5
check_gain_time:30
hysteresis: 25
heating_gain: 2

[extruder1]
step_pin: R_tool:PB1
dir_pin: R_tool:PB2
enable_pin: !R_tool:PB0
microsteps: 16
full_steps_per_rotation: 200
rotation_distance:23.5619445
gear_ratio: 2.53:1
nozzle_diameter: 0.400
filament_diameter: 1.750
max_extrude_only_distance: 500.0
max_extrude_only_velocity: 60.0
max_extrude_only_accel: 1000.0
max_extrude_cross_section:5
heater_pin: R_tool:PA8
max_power: 1.0
min_temp: -235
max_temp: 465
min_extrude_temp: 150
pressure_advance: 0.032
pressure_advance_smooth_time:0.040
control = pid
pid_kp = 10.391
pid_ki = 0.376
pid_kd = 71.698


[tmc2209 extruder1]
uart_pin:R_tool:PB7
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

[gcode_macro PARK_extruder]
gcode:
    SAVE_GCODE_STATE NAME=park0
    G90
    G1 X0 F6000
    RESTORE_GCODE_STATE NAME=park0

[gcode_macro T0]
gcode:
    PARK_{printer.toolhead.extruder}
    ACTIVATE_EXTRUDER EXTRUDER=extruder
    SET_DUAL_CARRIAGE CARRIAGE=0
    SET_GCODE_OFFSET Y=0
    G1 X10 F6000
    

[gcode_macro PARK_extruder1]
gcode:
    SAVE_GCODE_STATE NAME=park1
    G90
    G1 X495
    RESTORE_GCODE_STATE NAME=park1
    
[gcode_macro T1]
gcode:
    PARK_{printer.toolhead.extruder}
    ACTIVATE_EXTRUDER EXTRUDER=extruder1
    SET_DUAL_CARRIAGE CARRIAGE=1
    SET_GCODE_OFFSET Y=0
    G1 X485 F6000

[gcode_macro ACTIVATE_COPY_MODE]
gcode:
    SET_DUAL_CARRIAGE CARRIAGE=0 MODE=PRIMARY
    G1 X0
    ACTIVATE_EXTRUDER EXTRUDER=extruder
    SET_DUAL_CARRIAGE CARRIAGE=1 MODE=PRIMARY
    G1 X227.5
    SET_DUAL_CARRIAGE CARRIAGE=1 MODE=COPY
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder1 MOTION_QUEUE=extruder

[gcode_macro ACTIVATE_MIRROR_MODE]
gcode:
    SET_DUAL_CARRIAGE CARRIAGE=0 MODE=PRIMARY
    G1 X0
    ACTIVATE_EXTRUDER EXTRUDER=extruder
    SET_DUAL_CARRIAGE CARRIAGE=1 MODE=PRIMARY
    G1 X495
    SET_DUAL_CARRIAGE CARRIAGE=1 MODE=MIRROR
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder1 MOTION_QUEUE=extruder

    
[gcode_macro probe_start]
gcode:
    SET_SERVO SERVO=probe_servo angle=45 
    G4 P500

[gcode_macro probe_end]
gcode:
   G4 P500
   SET_SERVO SERVO=probe_servo angle=135


[gcode_arcs]
resolution: 1.0

[gcode_macro PRINT_START]
gcode:
    G28
   {% set BED_TEMP = params.BED|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER|float %}
    {% set EXTRUDER_TEMP1 = params.EXTRUDER1|default(0)|float %}
    {% set CHAMBER_TEMP = params.CHAMBER|default(0)|float %}
    M140 S{BED_TEMP}
    M104 S{EXTRUDER_TEMP}
    M104 T1 S{EXTRUDER_TEMP1}
    M141 S{CHAMBER_TEMP}
    T0
    G28
    BED_MESH_CALIBRATE
    M109 S{EXTRUDER_TEMP}
    M109 T1 S{EXTRUDER_TEMP1}
    G92 E0
    M117 Printing star...

[gcode_macro PRINT_END]
gcode:
    M400
    G92 E0
    G1 E-10.0 F3600
    G91
    G0 Z1.00 X20.0 Y20.0 F6000
    TURN_OFF_HEATERS
    M107
    G1 Z2 F3000
    G90
    G0 Y300 F3600
    BED_MESH_CLEAR

[gcode_macro M109]
rename_existing: M99109
gcode:
    {% if 'S' in params %}
      {% set s = params.S|float %}
      M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}  
      {% if printer[printer.toolhead.extruder].temperature >= s-4 %}  
      M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}  
      {% else %} 
          TEMPERATURE_WAIT SENSOR=extruder MINIMUM={s-4} MAXIMUM={s+10}   
      {% endif %}
    {% else %}
      M104 S0
    {% endif %}
    


[gcode_macro M140]
rename_existing: M99140
gcode:
      {% set s = params.S|float %}
	    {% if params.S is defined %}
      {% if params.S|float >= 100 %}
	    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=100
      {% else %}
      SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={params.S|int}
	    {% endif %} 
      {% endif %} 

[gcode_macro M141]
gcode:
    {% set s = params.S|default(0)|float %}
    SET_HEATER_TEMPERATURE HEATER=chamber target={s}

[gcode_macro M190]
rename_existing: M99190
gcode:
    {% if 'S' in params %}
        {% set s = (params.S|float,100)|min %}
        {% if params.S|float >= 20 %}
          {% if printer.heater_bed.temperature >= s-2 %}
          SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={s|int}
          TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={s-2} MAXIMUM={s+10}
          G4 P10000
          {% else %}
          SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={s|int}
          TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={s-2} MAXIMUM={s+10}
          G4 P20000
          {% endif %}
        {% else %}
          {% if printer.heater_bed.temperature >= s-2 %}
          SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={s|int}
          G4 P10000
          {% else %}
          SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={s|int}
          TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={s-2} MAXIMUM={s+10}
          G4 P10000
          {% endif %} 
        {% endif %} 
    {% else %}
      M140 S0
    {% endif %}


[gcode_macro M17]
gcode:
  {% if 'X' in params or 'Y' in params or 'Z' in params or 'E' in params %}
  {% if 'X' in params %}
      SET_STEPPER_ENABLE STEPPER=stepper_x enable=1
  {% endif %}
  {% if 'Y' in params %}
      SET_STEPPER_ENABLE STEPPER=stepper_y enable=1
  {% endif %}
  {% if 'Z' in params %}
      SET_STEPPER_ENABLE STEPPER=stepper_z enable=1
  {% endif %}
  {% if 'E' in params %}
      SET_STEPPER_ENABLE STEPPER=extruder enable=1
  {% endif %}
  {% else %}
      SET_STEPPER_ENABLE STEPPER=stepper_x enable=1
      SET_STEPPER_ENABLE STEPPER=stepper_y enable=1
      SET_STEPPER_ENABLE STEPPER=stepper_z enable=1
      #SET_STEPPER_ENABLE STEPPER=extruder enable=1
  {% endif %}

[gcode_macro M84]
rename_existing:M84.1
gcode:

  {% if 'X' in params or 'Y' in params or 'Z' in params or 'E' in params %}
  {% if 'X' in params %}
      SET_STEPPER_ENABLE STEPPER=stepper_x enable=0
  {% endif %}
  {% if 'Y' in params %}
      SET_STEPPER_ENABLE STEPPER=stepper_y enable=0
  {% endif %}
  {% if 'Z' in params %}
      SET_STEPPER_ENABLE STEPPER=stepper_z enable=0
  {% endif %}
  {% if 'E' in params %}
      SET_STEPPER_ENABLE STEPPER=extruder enable=0
  {% endif %}
  {% else %}
      SET_STEPPER_ENABLE STEPPER=stepper_x enable=0
      SET_STEPPER_ENABLE STEPPER=stepper_y enable=0
      SET_STEPPER_ENABLE STEPPER=stepper_z enable=0
      SET_STEPPER_ENABLE STEPPER=extruder enable=0
  {% endif %}

[gcode_macro LOAD_FILAMENT]
variable_load_distance:  100
variable_purge_distance:  25
gcode:
    {% set speed = params.SPEED|default(200) %}
    {% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity  * 60 %}
    SAVE_GCODE_STATE NAME=load_state
    G91
    G92 E0
    G1 E{load_distance} F{max_velocity} # fast-load
    G1 E{purge_distance} F{speed} # purge
    RESTORE_GCODE_STATE NAME=load_state

[gcode_macro UNLOAD_FILAMENT]
variable_unload_distance:  100
variable_purge_distance:  25
gcode:
    {% set speed = params.SPEED|default(200) %}
    {% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity  * 60 %}
    SAVE_GCODE_STATE NAME=unload_state
    G91
    G92 E0
    G1 E{purge_distance} F{speed} # purge
    G1 E-{unload_distance} F{max_velocity} # fast-unload
    RESTORE_GCODE_STATE NAME=unload_state
